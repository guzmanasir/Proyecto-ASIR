/**
 * Created by guzman on 4/02/17.
 */

/**
 * Core librería
 */
angular.module("proyecto", [
    'ui.router',
    'ngMaterial',
    'satellizer'
]).config(function($mdThemingProvider) {
    $mdThemingProvider.theme('default')
        .primaryPalette('grey')
        .accentPalette('blue');
});
/**
 * Created by guzman on 4/02/17.
 */



(function() {
    function routes($stateProvider,$locationProvider,$authProvider){
        $locationProvider.html5Mode(true);
        $authProvider.loginUrl = '/loginForm';
        $authProvider.tokenName = 'token';
        $authProvider.tokenPrefix = 'miApp';
        $stateProvider

            .state('home',{
                abstract: true,
                templateUrl: '/frameNoAuth'
            })

            .state('home.login',{
                url: "/",
                controller: 'loginCtrl',
                controllerAs: 'lc',
                templateUrl: '/login'
            })

            .state('home.registro',{
                url: "/signup",
                controller: 'registroCtrl',
                controllerAs: 'rc',
                templateUrl: '/registro'
            })

            .state('main',{
                abstract: true,
                controller: 'frameCtrl',
                controllerAs: 'fc',
                templateUrl: '/users/frame'
            })


            .state('main.nuevos',{
                url: "/nuevos",
                //controller: 'indexController',
                //controllerAs: 'ic',
                templateUrl: '/users/tempNuevos',
                params: {requireLogin : true}
            })

            .state('main.populares',{
                url: "/populares",
                //controller: 'indexController',
                //controllerAs: 'ic',
                templateUrl: '/users/tempPopulares',
                params: {requireLogin : true}
            })

            .state('main.recomendaciones',{
                url: "/recomendaciones",
                //controller: 'indexController',
                //controllerAs: 'ic',
                templateUrl: '/users/tempRecomendaciones',
                params: {requireLogin : true}
            })

            .state('main.logout',{
                url: "/logout",
                controller: 'logoutCtrl',
                controllerAs: 'lgc',
                template: '<p>Logout</p>'
            })

            .state('403',{
                url: "/403",
                templateUrl: '/403'
            })



    }

    angular.module('proyecto')
        .config(['$stateProvider', '$locationProvider', '$authProvider',routes]);

})();


/**
 * Created by jesus on 18/05/17.
 */
(function() {
    function run($rootScope,$state,$auth){

        $rootScope.$on('Loginfail',function(datos){
            $state.go('403')
        })

        $rootScope.$on('$stateChangeStart',
            function(event, toState, toParams, fromState, fromParams, options){
                if ( toState.data && toState.data.requireLogin && $auth.isAuthenticated() ) {
                    event.preventDefault();
                    $state.go('403');
                }
                // transitionTo() promise will be rejected with
                // a 'transition prevented' error
            })
    }

    angular.module('proyecto')
        .run(['$rootScope','$state', '$auth', run]);

})();

/**
 * Created by guzman on 4/02/17.
 */



(function() {
    function frameCtrl($http,$state,$auth, $mdDialog){
        var vm = this;
        vm.name = "asdd"
        vm.cualquiera = "aa"
        vm.showAdvanced = function(ev) {
            $mdDialog.show({
                controller: function(){
                    var vmd = this;
                    vmd.urls = [];
                    vmd.tags = [];

                    vmd.answer = function(){
                        vm.name = vmd.nombre;
                        $mdDialog.hide();
                    }

                    vmd.close = function() {
                        $mdDialog.hide();
                    }

                    vmd.addUrl = function() {
                        vmd.urls.push({
                            url: vmd.url,
                            artista: "unknown",
                            cancion: "unknown"
                        })

                        vmd.url = "";
                    }



                    vm.urls = vmd.urls;
                    vm.tags = vmd.tags;

                },
                controllerAs: "mc",
                templateUrl: '/users/addListDialog',
                parent: angular.element(document.body),
                targetEvent: ev
                // clickOutsideToClose:true
            })
                .then(function() {
                    console.log("vm.name ",vm.name)
                    var dataList = {
                        nombreServer: vm.name,
                        tagsServer: vm.tags,
                        urlsServer: vm.urls
                    }
                    $http.post('/users/addList', dataList)
                    .then(function(responseOk){
                        console.log(responseOk)
                    },function(responseFail){
                        console.error(responseFail);
                    })

                }, function() {
                    console.log("asdal")
;                });
        };

    }

    angular.module('proyecto')
        .controller('frameCtrl',['$http','$state', '$auth','$mdDialog', frameCtrl]);

})();

/**
 * Created by jesus on 18/05/17.
 */
(function() {
    function logoutCtrl($http,$state,$auth){
        var vm = this;
        $auth.logout()
        $state.go('home.login')



    }

    angular.module('proyecto')
        .controller('logoutCtrl',['$http','$state', '$auth', logoutCtrl]);

})();

/**
 * Created by jesus on 21/05/17.
 */

/**
 * Created by guzman on 4/02/17.
 */



(function() {
    function loginCtrl($http,$auth,$state,$rootScope){
        var vm = this;
        vm.login = function(){

            console.log("Info login", vm.usernameModel, vm.passwordModel)
            /**
             * TODO: Llamada al servidor
             */
            var json = {
                usernameServer : vm.usernameModel,
                passwordServer : vm.passwordModel
            };
            $auth.login(json)
                .then(function(response){
                        if (response.data.codigo === 500)
                            // swal(
                            //     'Oops...',
                            //     'Error al iniciar sesión',
                            //     'error'
                            // )
                            $rootScope.$emit("Loginfail",response)
                        else{
                            $state.go('main.nuevos')
                        }

                    },
                    function(response) {
                        // swal(
                        //     'Oops...',
                        //     'Error de servidor',
                        //     'error'
                        // )
                        $rootScope.$emit("Loginfail",response)

                    });
        }
    }

    angular.module('proyecto')
        .controller('loginCtrl',['$http','$auth','$state', '$rootScope', loginCtrl]);

})();

/**
 * Created by guzman on 4/02/17.
 */


(function() {
    function registroCtrl($http){
        var vm = this;
        vm.registro = function(){
            var json = {
                usernameRegistro : vm.usernameModel,
                passwordRegistro : vm.passwordModel,
                emailRegistro : vm.emailModel
            };

            $http.post('/registerForm',json)
                .then(function(response){
                        console.log("respuesta",response);
                        vm.status = "OK";
                    },
                    function(response) {
                        vm.status = "Fallo";
                        console.log("fallo")
                        swal(
                            'Oops...',
                            'Error al registrar!',
                            'error'
                        )
                    });

        }
    }

    angular.module('proyecto')
        .controller('registroCtrl',['$http',registroCtrl]);

})();
